name: ğŸš€ Deploy MLflow to HuggingFace Spaces

on:
  push:
    branches:
      - main
    paths:
      - '04_mlflow/**'
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ“Š Deploy MLflow Tracking Server
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¥ Installing dependencies..."
          python -m pip install --upgrade pip
          python -m pip install huggingface_hub gitpython
          echo "âœ… Dependencies installed"
      
      - name: ğŸš€ Deploy to HuggingFace Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          SPACE_NAME: wakee-mlflow
        run: |
          python - <<'PYTHON_SCRIPT'
          import os
          import subprocess
          from pathlib import Path
          from huggingface_hub import HfApi, create_repo
          
          # Configuration
          HF_TOKEN = os.environ['HF_TOKEN']
          HF_USERNAME = 'Terorra'
          SPACE_NAME = 'wakee-mlflow'
          REPO_ID = 'Terorra/wakee-mlflow'
          
          print("=" * 64)
          print("ğŸš€ DEPLOYING MLFLOW TO HUGGINGFACE SPACES")
          print("=" * 64)
          print(f"ğŸ“Š Space: {REPO_ID}")
          print(f"ğŸ“ Source: 04_mlflow/")
          print("=" * 64)
          
          # Initialize API
          api = HfApi(token=HF_TOKEN)
          
          # Check if space exists
          print("\nğŸ” Checking if Space exists...")
          try:
              api.space_info(REPO_ID)
              print(f"âœ… Space exists: {REPO_ID}")
              space_exists = True
          except Exception:
              print(f"ğŸ†• Space not found, will create: {REPO_ID}")
              space_exists = True
          
          # Create space if doesn't exist
          if not space_exists:
              print("\nğŸ†• Creating new Space...")
              try:
                  create_repo(
                      repo_id=SPACE_NAME,
                      token=HF_TOKEN,
                      repo_type="space",
                      space_sdk="docker"
                  )
                  print(f"âœ… Space created: {REPO_ID}")
              except Exception as e:
                  print(f"âŒ Failed to create space: {e}")
                  exit(1)
          
          # Clone space
          print(f"\nğŸ“¥ Cloning Space...")
          os.chdir("04_mlflow")
          
          subprocess.run([
              "git", "clone",
              f"https://oauth2:{HF_TOKEN}@huggingface.co/spaces/{REPO_ID}",
              "space_repo"
          ], check=True)
          
          print("âœ… Space cloned")
          
          # Prepare files
          print("\nğŸ“‹ Preparing files for deployment...")
          
          files_to_copy = {
              "Dockerfile": "ğŸ“„ Copying Dockerfile...",
              "requirements.txt": "ğŸ“„ Copying requirements.txt...",
              "README.md": "ğŸ“„ Copying README.md...",
              ".dockerignore": "ğŸ“„ Copying .dockerignore..."
          }
          
          for file, msg in files_to_copy.items():
              print(f"  {msg}")
              src = Path(file)
              dst = Path("space_repo") / file
              if src.exists():
                  dst.write_text(src.read_text())
              elif file != ".dockerignore":  # .dockerignore is optional
                  print(f"    âš ï¸  {file} not found")
          
          # Remove app.py if exists
          app_py = Path("space_repo/app.py")
          if app_py.exists():
              print("  ğŸ—‘ï¸  Removing old app.py...")
              app_py.unlink()
          
          print("âœ… Files prepared")
          
          # Git operations
          print("\nğŸ“¤ Pushing to HuggingFace Spaces...")
          os.chdir("space_repo")
          
          subprocess.run(["git", "config", "user.name", "ğŸ¤– GitHub Actions Bot"], check=True)
          subprocess.run(["git", "config", "user.email", "actions@github.com"], check=True)
          subprocess.run(["git", "add", "."], check=True)
          subprocess.run(["git", "add", "-u"], check=True)
          
          # Check if there are changes
          result = subprocess.run(["git", "diff", "--staged", "--quiet"])
          
          if result.returncode == 0:
              print("â„¹ï¸  No changes to deploy")
          else:
              from datetime import datetime
              commit_msg = f"ğŸš€ Deploy MLflow {datetime.now().strftime('%Y-%m-%d %H:%M')}"
              subprocess.run(["git", "commit", "-m", commit_msg], check=True)
              subprocess.run(["git", "push"], check=True)
              print("âœ… Deployment successful!")
          
          PYTHON_SCRIPT
      
      - name: ğŸ‰ Deployment Summary
        if: success()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ MLFLOW DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š MLflow Tracking Server deployed to:"
          echo "   ğŸ”— https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/wakee-mlflow"
          echo ""
          echo "ğŸ“‹ Files deployed:"
          echo "   âœ… Dockerfile"
          echo "   âœ… requirements.txt"
          echo "   âœ… README.md"
          echo "   âœ… .dockerignore"
          echo ""
          echo "âš™ï¸  Configuration:"
          echo "   ğŸ“¦ No app.py (MLflow runs directly)"
          echo "   ğŸ³ Docker SDK"
          echo "   ğŸ Python 3.11"
          echo ""
          echo "ğŸ”§ Next steps:"
          echo "   1. Configure environment variables in Space Settings"
          echo "   2. Wait for Space to build (~3-5 minutes)"
          echo "   3. Access MLflow UI at the URL above"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ MLFLOW DEPLOYMENT FAILED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ” Troubleshooting:"
          echo "   1. Check HF_TOKEN secret is set correctly"
          echo "   2. Check HF_USERNAME secret is set correctly"
          echo "   3. Verify files exist in 04_mlflow/"
          echo "   4. Check Space permissions"
          echo ""
          echo "ğŸ“š Documentation:"
          echo "   https://huggingface.co/docs/hub/spaces"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
