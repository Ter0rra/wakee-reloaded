name: ğŸš€ Deploy MLflow to HuggingFace Spaces

on:
  push:
    branches:
      - main
    paths:
      - '04_mlflow/**'
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ“Š Deploy MLflow Tracking Server
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install HuggingFace CLI
        run: |
          echo "ğŸ“¥ Installing huggingface_hub..."
          pip install --quiet huggingface_hub
          echo "âœ… HuggingFace CLI installed"
      
      - name: ğŸ” Login to HuggingFace
        run: |
          echo "ğŸ” Authenticating with HuggingFace..."
          huggingface-cli login --token ${{ secrets.HF_TOKEN }}
          echo "âœ… Authentication successful"
      
      - name: ğŸš€ Deploy to HuggingFace Spaces
        env:
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          SPACE_NAME: wakee-mlflow
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ DEPLOYING MLFLOW TO HUGGINGFACE SPACES"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Space: $HF_USERNAME/$SPACE_NAME"
          echo "ğŸ“ Source: 04_mlflow/"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          cd 04_mlflow
          
          # Check if space exists
          echo ""
          echo "ğŸ” Checking if Space exists..."
          if huggingface-cli repo info spaces/$HF_USERNAME/$SPACE_NAME > /dev/null 2>&1; then
            echo "âœ… Space exists, cloning..."
            git clone https://huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME space_repo
          else
            echo "ğŸ†• Space not found, creating new Space..."
            huggingface-cli repo create $SPACE_NAME --type space --space_sdk docker
            echo "âœ… Space created"
            git clone https://huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME space_repo
          fi
          
          echo ""
          echo "ğŸ“‹ Preparing files for deployment..."
          
          # Copy files
          echo "  ğŸ“„ Copying Dockerfile..."
          cp Dockerfile space_repo/
          
          echo "  ğŸ“„ Copying requirements.txt..."
          cp requirements.txt space_repo/
          
          echo "  ğŸ“„ Copying README.md..."
          cp README.md space_repo/
          
          echo "  ğŸ“„ Copying .dockerignore..."
          cp .dockerignore space_repo/ 2>/dev/null || echo "  âš ï¸  .dockerignore not found (optional)"
          
          # Clean up app.py if exists
          if [ -f space_repo/app.py ]; then
            echo "  ğŸ—‘ï¸  Removing old app.py..."
            rm -f space_repo/app.py
          fi
          
          echo "âœ… Files prepared"
          
          # Git operations
          echo ""
          echo "ğŸ“¤ Pushing to HuggingFace Spaces..."
          cd space_repo
          
          git config user.name "ğŸ¤– GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add .
          git add -u
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to deploy"
          else
            git commit -m "ğŸš€ Deploy MLflow $(date '+%Y-%m-%d %H:%M')"
            git push
            echo "âœ… Deployment successful!"
          fi
      
      - name: ğŸ‰ Deployment Summary
        if: success()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ MLFLOW DEPLOYMENT COMPLETED SUCCESSFULLY!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š MLflow Tracking Server deployed to:"
          echo "   ğŸ”— https://huggingface.co/spaces/${{ secrets.HF_USERNAME }}/wakee-mlflow"
          echo ""
          echo "ğŸ“‹ Files deployed:"
          echo "   âœ… Dockerfile"
          echo "   âœ… requirements.txt"
          echo "   âœ… README.md"
          echo "   âœ… .dockerignore"
          echo ""
          echo "âš™ï¸  Configuration:"
          echo "   ğŸ“¦ No app.py (MLflow runs directly)"
          echo "   ğŸ³ Docker SDK"
          echo "   ğŸ Python 3.11"
          echo ""
          echo "ğŸ”§ Next steps:"
          echo "   1. Configure environment variables in Space Settings"
          echo "   2. Wait for Space to build (~3-5 minutes)"
          echo "   3. Access MLflow UI at the URL above"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ MLFLOW DEPLOYMENT FAILED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ” Troubleshooting:"
          echo "   1. Check HF_TOKEN secret is set correctly"
          echo "   2. Check HF_USERNAME secret is set correctly"
          echo "   3. Verify files exist in 04_mlflow/"
          echo "   4. Check Space permissions"
          echo ""
          echo "ğŸ“š Documentation:"
          echo "   https://huggingface.co/docs/hub/spaces"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
